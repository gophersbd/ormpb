package generator

import (
	"bytes"
	"fmt"
	"reflect"
	"text/template"

	"github.com/gophersbd/ormpb/pkg/descriptor"
	"github.com/gophersbd/ormpb/protobuf"
)

func printInterface(v interface{}) string {
	switch reflect.ValueOf(v).Kind() {
	case reflect.String:
		return fmt.Sprintf(`"%v"`, v)
	default:
		return fmt.Sprintf("%v", v)
	}
}

type param struct {
	*descriptor.File
	Imports    []descriptor.GoPackage
	ColumnTags []string
}

func applyTemplate(p param) (string, error) {
	w := bytes.NewBuffer(nil)

	p.ColumnTags = make([]string, 0)
	t := protobuf.ColumnOptions{}
	co := reflect.ValueOf(&t).Elem()
	typeOfCO := co.Type()

	for i := 0; i < co.NumField(); i++ {
		p.ColumnTags = append(p.ColumnTags, typeOfCO.Field(i).Name)
	}

	helperTemplate := template.New("orm")
	helperTemplate.Funcs(template.FuncMap{"printInterface": printInterface})

	ormTemplate := template.Must(helperTemplate.Parse(ormTemplate))

	if err := ormTemplate.Execute(w, p); err != nil {
		return "", err
	}
	return w.String(), nil
}

var (
	ormTemplate = `
// Code generated by protoc-gen-orm. DO NOT EDIT.
// source: {{ .GetName }}

package {{ .GoPkg.Name }}

const(
{{ range $t := .ColumnTags }}
ColumnTag{{ $t }} = "{{ $t }}"
{{- end }}
)

{{ range $msg := .Messages }}

func (*{{ $msg.Name }}) TableName() string {
	return "{{ $msg.TableOption.GetName }}"
}

var (
	_{{ $msg.Name }}TagMap = map[string]map[string]interface{}{
		{{- range $f := $msg.Fields }}
		"{{ $f.Name }}": {
			{{- range $key, $value := $f.ColumnTags }}
				{{- if $value }}
					ColumnTag{{ $key }}: {{ $value | printInterface }},
				{{- end }}
			{{- end }}
		},
		{{- end }}
	}
)

func (*{{ $msg.Name }}) Tag(field, tag string) (val interface{}, found bool) {
	val, found = _{{ $msg.Name }}TagMap[field][tag]
	return
}
{{- end }}
`
)
